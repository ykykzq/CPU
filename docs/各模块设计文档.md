# 模块说明文档（待更新）

暂时先对各个非流水级的模块进行一个简要说明，其他模块待更新。

## WakeUP

唤醒/阻塞模块。这里参考了超标量中的思想，把逻辑从`当数据未准备好时阻塞`改为`只有数据准备好了才允许发射`。目前我们有若干单元都需要用到来自寄存器的值，因此有若干个标志信号。

分为三种：

1. BU（BranchUnit）。跳转指令可能需要读寄存器，例如beq指令需要比较两个寄存器的值，才能决定是否跳转。因此需要判断BU模块的操作数是否已经可以从寄存器堆/旁路中读取。
2. ALU。只有当ALU的源操作数准备好时，才允许当前流水级流动。
3. Data RAM。数据RAM也需要来自寄存器堆的数据。例如，对于st.w指令，需要读两个寄存器，一个寄存器值参与地址运算，一个寄存器值决定写入该地址的数据。

指令是否能够发射（ID_ready_go），是由该模块的所有生成信号共同决定的。

## RegFile

寄存器堆，设计上非常简单，类似一个二维数组。为保证一周期内能读完，设计两个读端口一个写端口。

## Bypassing

从ID流水级（该流水级准备好源操作数）开始，后续的模块都需要通过旁路模块，把**已经有效的写回寄存器堆的值**旁路回ID流水级，以使处在ID流水级的指令能更早的获得源操作数，减少气泡（bubble）的数量。

可能需要把WB流水级对写回寄存器值的选择逻辑重复一遍。

## BranchUnit

该模块根据指令类型与源操作数决定：

1. 是否为跳转指令
2. 如果是跳转指令，是否要发生跳转
3. 如果要发生跳转，跳转的目标地址是什么
4. 跳转的目标地址是否与之前**预测**的跳转地址相同，相同证明分支预测正确，不同证明预测失败，把错误的指令从流水线中flush掉

注意：

- `之前预测的地址`实际上就是当前在IPD流水级的指令。

## MMU

完成：

1. `Inst RAM`与`Data RAM`向`Base RAM`与`Ext RAM`的映射。这是因为在《CPU设计实战》中，我们使用的是哈佛架构，然而在NSCSCSC模板文件中，使用的是冯诺依曼架构，所有地址可读可写可执行。也就是说，存在先写入RAM某些数据，然后以指令格式读取并执行这些数据的可能。

> 实际上对于功能测试3与性能测试，就是通过监控程序，把测试程序从串口写入到指定位置并执行。

2. 对结构冒险的处理。如果两个访存行为映射到同一物理RAM，阻塞**取指令**流水级一周期。

> 猜猜阻塞取数据的流水级会发生什么？

3. 串口的控制。访存行为不一定映射到两块RAM，也有可能是映射到串口。通过访存指令的地址，我们可以判断是否是对串口的读写。